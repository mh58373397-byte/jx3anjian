# 丐帮高手 v3.2 — 驱动级键盘/鼠标连发工具

基于 [Interception](https://github.com/oblitum/Interception) 驱动的高性能连发工具，在驱动层模拟键盘和鼠标输入，支持微秒级精度控制。带可视化键盘布局的图形界面，点击即可配置。

## 功能特性

- **驱动级按键模拟** — 通过 Interception 驱动在内核层发送键盘/鼠标事件，非应用层模拟
- **三种连发模式** — Hold（按住连发）、Toggle（指定连发）、Hybrid（混合模式）
- **键盘+鼠标支持** — 键盘按键和鼠标五键（左/右/中/X1/X2）均可连发
- **可视化键盘布局** — 界面内嵌键盘图（含鼠标键），点击即可设置排除/连发
- **微秒级延迟控制** — 延迟范围 1μs ~ 1000ms，极速模式可突破 1ms 下限
- **暂停模式** — 停止连发时保留已指定的按键，下次启动自动恢复
- **极速模式** — 允许按键间隔低于 1ms，最低可达 1μs
- **游戏模式** — 半透明无边框悬浮窗，不遮挡游戏画面
- **实时速度显示** — 显示每秒实际按键次数（PPS）
- **可自定义快捷键** — 启动/关闭连发、游戏模式的热键均可自定义
- **配置持久化** — 所有设置自动保存/加载
- **驱动管理** — 支持一键安装和卸载驱动

---

## 安装与首次运行

### 1. 编译（如果没有现成 exe）

**环境要求：** Windows 10/11 x64 + Visual Studio 2022

```bat
build.bat
```

### 2. 首次运行

1. 双击运行 `autokey.exe`
2. 程序检测到 Interception 驱动未安装，弹出提示框，点击 **"是"**
3. 以管理员权限自动安装驱动
4. **安装完成后必须重启电脑**，驱动才能加载
5. 重启后再次运行 `autokey.exe`，界面显示 **"✔ Interception 驱动就绪"** 即可使用

---

## 快捷键一览

| 默认按键 | 功能 | 说明 |
|----------|------|------|
| **F1** | 开启/关闭连发 | 主开关，可在界面中点击「改」自定义 |
| **F9** | 游戏模式 | 切换半透明悬浮窗，可在界面中点击「改」自定义 |

> 快捷键可在界面中点击「启动」或「游戏」旁的「改」按钮重新设置，按 Esc 取消设置。

---

## 详细功能说明

### 三种连发模式

| 模式 | 说明 |
|------|------|
| **Hold（按住连发）** | 按住任意键 = 连发，松开 = 停止。橙色键可连发，红色键为排除 |
| **Toggle（指定连发）** | 按一下白名单中的键 = 开始连发，再按 = 停止。绿色键为已选 |
| **Hybrid（混合模式）** | 绿色键可 Toggle，橙色键可 Hold，红色键为排除。同时支持两种方式 |

### 按键设置方式

通过**点击界面上的键盘图**来设置：

- **Hold 模式**：点击键盘上的键，橙色↔红色切换（连发↔不连发）
- **Toggle 模式**：点击键盘上的键，绿色↔灰色切换（已选↔未选）
- **Hybrid 模式**：点击循环切换：绿色（指定连发）→ 红色（排除）→ 橙色（按住连发）

灰色键为热键（启动/游戏），不可配置。

### 鼠标按键

键盘图右上方显示 5 个鼠标按键（ML/MR/MM/X1/X2），设置方式与键盘相同。

### 暂停模式

勾选 **「暂停模式」** 后，启动/停止的逻辑变为启动/暂停：
- 停止连发时**保留**已指定的按键状态
- 下次启动时自动恢复之前的连发按键
- 适用于需要记忆指定连发按键的场景

### 极速模式

勾选 **「极速模式」** 后：
- 允许按键间隔低于 1ms（最低可达 1μs）
- **警告**：过低的间隔可能导致电脑卡死，请谨慎使用

### 延迟调节

使用界面上的 **-** 和 **+** 按钮调节按键间隔：

| 延迟范围 | 步进 | 说明 |
|---------|------|------|
| ≥ 10ms | 每次 1ms | 标准模式 |
| 1ms ~ 9.9ms | 每次 100μs | 显示 μs 和 ms 双单位 |
| < 1ms（极速模式） | 10μs / 1μs | 需开启极速模式 |

### 游戏模式

点击 **「游戏模式」** 按钮或按默认热键 **F9**：

- 窗口变为半透明无边框悬浮窗（约 35% 不透明度）
- 仅显示：**状态** / **连发中的按键** / **速度**
- 鼠标拖拽窗口可移动，右键弹出菜单
- 窗口位置和大小自动记忆

再次点击或按热键退出游戏模式。

---

## 配置文件

所有设置自动保存到程序同目录的 `config.json`：

```json
{
  "delay_us": 1000,
  "mode": 0,
  "exclude": [1, 2, 4, 5, 6, 8, 9, 13, ...],
  "custom_keys": [],
  "game_x": 1295, "game_y": 253, "game_w": 200, "game_h": 80,
  "hk_toggle": 112, "hk_game": 120,
  "key_lock": 1,
  "turbo": 1
}
```

| 字段 | 说明 |
|------|------|
| `delay_us` | 延迟（微秒），1000 = 1ms |
| `mode` | 0 = Hold，1 = Toggle，2 = Hybrid |
| `exclude` | Hold 模式排除键的 VK 码列表 |
| `custom_keys` | Toggle 模式白名单键的 VK 码列表 |
| `game_x/y/w/h` | 游戏模式窗口位置和大小 |
| `hk_toggle` | 启动/关闭连发热键的 VK 码（默认 112 = F1） |
| `hk_game` | 游戏模式热键的 VK 码（默认 120 = F9） |
| `key_lock` | 暂停模式开关（1 = 开启） |
| `turbo` | 极速模式开关（1 = 开启） |

---

## 项目结构

```
├── main.c                    # 主程序源码（单文件，约 1750 行）
├── build.bat                 # 一键编译脚本
├── interception.h            # Interception 驱动 API 头文件
├── interception.dll          # Interception 运行库（编译时嵌入 exe）
├── install-interception.exe  # 驱动安装程序（编译时嵌入 exe）
├── resource.h                # 资源 ID 定义
├── resource.rc               # 资源脚本（将 dll 和 exe 嵌入）
├── app.manifest              # 应用程序清单
└── autokey.exe               # 编译产物
```

编译后生成单个 `autokey.exe`，内嵌了 `interception.dll` 和 `install-interception.exe`，无需额外文件即可运行和安装驱动。

## 技术实现

- **按键捕获：** Interception 驱动拦截所有键盘和鼠标事件，记录按下/释放状态
- **按键发送：** `interception_send()` 批量发送按下+释放两个事件（1 次调用）
- **高精度计时：** `QueryPerformanceCounter` 实现微秒级延迟精度，大延迟用 `Sleep` 节省 CPU，最后一段用 QPC 自旋精确等待
- **线程模型：** 捕获线程 + 发送线程分离，发送线程设为 `THREAD_PRIORITY_TIME_CRITICAL`
- **线程安全：** 活跃槽位使用临界区保护，PPS 计数使用原子操作，按键状态使用快照读取
- **活跃按键追踪：** 最多 16 个活跃槽位，预计算扫描码和 flags，热循环零系统调用开销
- **双缓冲渲染：** 缓存兼容 DC 和 bitmap，仅窗口大小变化时重建，避免每帧分配
- **DLL 动态加载：** 从资源释放 `interception.dll` 到临时目录后加载，单 exe 分发

## 注意事项

- Interception 驱动安装需要**管理员权限**
- 安装驱动后必须**重启电脑**
- 可通过界面「卸载驱动」按钮卸载 Interception 驱动
- 部分反作弊系统可能检测 Interception 驱动，请自行评估风险
- 启动热键和游戏模式热键在连发中不会被触发

## 依赖

- [Interception](https://github.com/oblitum/Interception) — 键盘/鼠标驱动级拦截框架

## License

MIT
