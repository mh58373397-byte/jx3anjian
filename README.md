# AutoKey - 驱动级键盘连发工具

基于 [Interception](https://github.com/oblitum/Interception) 驱动的高性能键盘连发工具，在驱动层模拟按键输入，支持微秒级精度控制。带可视化键盘布局的图形界面，点击即可配置。

## 功能特性

- **驱动级按键模拟** — 通过 Interception 驱动在内核层发送键盘事件，非应用层模拟
- **三种连发模式** — Hold（按住连发）、Toggle（指定连发）、Hybrid（混合模式）
- **可视化键盘布局** — 界面内嵌键盘图，点击按键即可设置排除/连发，无需记忆快捷键
- **微秒级延迟控制** — 延迟范围 100μs ~ 1000ms，支持 burst 模式突破极限速度
- **游戏模式** — 半透明无边框悬浮窗，不遮挡游戏画面
- **实时速度显示** — 显示每秒实际按键次数（PPS）
- **可自定义快捷键** — 启动/关闭连发、游戏模式的热键均可自定义
- **配置持久化** — 所有设置自动保存/加载
- **驱动自动安装** — 首次运行自动引导安装

---

## 安装与首次运行

### 1. 编译（如果没有现成 exe）

**环境要求：** Windows 10/11 x64 + Visual Studio 2022

```bat
build.bat
```

### 2. 首次运行

1. 双击运行 `autokey.exe`
2. 程序检测到 Interception 驱动未安装，弹出提示框，点击 **"是"**
3. 以管理员权限自动安装驱动
4. **安装完成后必须重启电脑**，驱动才能加载
5. 重启后再次运行 `autokey.exe`，界面显示 **"✔ Interception 驱动就绪"** 即可使用

---

## 快捷键一览

| 默认按键 | 功能 | 说明 |
|----------|------|------|
| **小键盘 7** | 开启/关闭连发 | 主开关，可在界面中点击「改」自定义 |
| **F9** | 游戏模式 | 切换半透明悬浮窗，可在界面中点击「改」自定义 |

> 快捷键可在界面中点击「启动」或「游戏」旁的「改」按钮重新设置，按 Esc 取消设置。

---

## 详细功能说明

### 三种连发模式

| 模式 | 说明 |
|------|------|
| **Hold（按住连发）** | 按住任意键 = 连发，松开 = 停止。橙色键可连发，红色键为排除 |
| **Toggle（指定连发）** | 按一下白名单中的键 = 开始连发，再按 = 停止。绿色键为已选 |
| **Hybrid（混合模式）** | 绿色键可 Toggle，橙色键可 Hold，红色键为排除。同时支持两种方式 |

### 按键设置方式

通过**点击界面上的键盘图**来设置：

- **Hold 模式**：点击键盘上的键，橙色↔红色切换（连发↔不连发）
- **Toggle 模式**：点击键盘上的键，绿色↔灰色切换（已选↔未选）
- **Hybrid 模式**：绿色=指定连发，橙色=按住连发，红色=排除

灰色键为热键（启动/游戏），不可配置。

### 默认排除键（Hold 模式）

W、A、S、D、Tab、Space、Enter、Shift、Caps、Esc、Backspace、方向键、F1~F12、Win、Ctrl、Alt、NumLock、Scroll 等系统/移动相关键默认不连发。

### 默认指定键（Toggle 模式）

F、G 默认加入白名单。

### 延迟调节

使用界面上的 **-** 和 **+** 按钮调节按键间隔：

| 延迟范围 | 步进 | 显示格式 |
|---------|------|---------|
| ≥ 10ms | 每次 1ms | `50ms` |
| 100μs ~ 9.9ms | 每次 100μs | `900μs (0.9ms)` |
| 100μs（最小值） | 进入 burst 模式 | `100μs x5` |

**Burst 模式：** 延迟减到 100μs 后，继续按 **-** 增加每周期发送次数（100μs x1 → x2 → ... → x1000），按 **+** 反向操作。

### 游戏模式

点击 **「游戏模式」** 按钮或按默认热键 **F9**：

- 窗口变为半透明无边框悬浮窗（约 35% 不透明度）
- 仅显示：**状态** / **连发中的按键** / **速度**
- 鼠标拖拽窗口可移动
- 窗口位置和大小自动记忆

再次点击或按热键退出游戏模式。

---

## 配置文件

所有设置自动保存到程序同目录的 `config.json`：

```json
{
  "delay_us": 50000,
  "burst": 1,
  "mode": 0,
  "exclude": [87, 65, 83, 68, 9, 32, 13, 16],
  "custom_keys": [70, 71],
  "game_x": 100,
  "game_y": 200,
  "game_w": 200,
  "game_h": 80,
  "hk_toggle": 103,
  "hk_game": 120
}
```

| 字段 | 说明 |
|------|------|
| `delay_us` | 延迟（微秒），50000 = 50ms |
| `burst` | burst 模式倍数，默认 1 |
| `mode` | 0 = Hold，1 = Toggle，2 = Hybrid |
| `exclude` | Hold 模式排除键的 VK 码列表 |
| `custom_keys` | Toggle 模式白名单键的 VK 码列表 |
| `game_x/y/w/h` | 游戏模式窗口位置和大小 |
| `hk_toggle` | 启动/关闭连发热键的 VK 码（默认 103 = 小键盘 7） |
| `hk_game` | 游戏模式热键的 VK 码（默认 120 = F9） |

---

## 项目结构

```
├── main.c                    # 主程序源码（单文件，约 1200 行）
├── build.bat                 # 一键编译脚本
├── interception.h            # Interception 驱动 API 头文件
├── interception.dll          # Interception 运行库（编译时嵌入 exe）
├── install-interception.exe  # 驱动安装程序（编译时嵌入 exe）
├── resource.h                # 资源 ID 定义
├── resource.rc               # 资源脚本（将 dll 和 exe 嵌入）
└── autokey.exe               # 编译产物（可选提交）
```

编译后生成单个 `autokey.exe`，内嵌了 `interception.dll` 和 `install-interception.exe`，无需额外文件即可运行和安装驱动。

## 技术实现

- **按键捕获：** Interception 驱动拦截所有键盘事件，记录按下/释放状态
- **按键发送：** `interception_send()` 批量发送按下+释放两个事件（1 次调用）
- **高精度计时：** `QueryPerformanceCounter` 实现微秒级延迟精度，大延迟用 `Sleep` 节省 CPU，最后一段用 QPC 自旋精确等待
- **线程模型：** 捕获线程 + 发送线程分离，发送线程设为 `THREAD_PRIORITY_TIME_CRITICAL`
- **活跃按键追踪：** 最多 16 个活跃槽位，预计算扫描码和 flags，热循环零系统调用开销
- **DLL 动态加载：** 从资源释放 `interception.dll` 到临时目录后加载，单 exe 分发

## 注意事项

- Interception 驱动安装需要**管理员权限**
- 安装驱动后必须**重启电脑**
- 部分反作弊系统可能检测 Interception 驱动，请自行评估风险
- 启动热键和游戏模式热键在连发中不会被触发

## 依赖

- [Interception](https://github.com/oblitum/Interception) — 键盘/鼠标驱动级拦截框架

## License

MIT
