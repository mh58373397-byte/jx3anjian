# AutoKey - 驱动级键盘连发工具

基于 [Interception](https://github.com/oblitum/Interception) 驱动的高性能键盘连发工具，在驱动层模拟按键输入，支持微秒级精度控制。

## 功能特性

- **驱动级按键模拟** — 通过 Interception 驱动在内核层发送键盘事件，非应用层模拟
- **两种连发模式** — Hold（按住连发）和 Toggle（按一下开始/再按停止）
- **微秒级延迟控制** — 延迟范围 100μs ~ 1000ms，支持 burst 模式突破极限速度
- **游戏模式** — 半透明无边框悬浮窗，不遮挡游戏画面
- **实时速度显示** — 显示每秒实际按键次数（PPS）
- **配置持久化** — 所有设置自动保存/加载
- **驱动自动安装** — 首次运行自动引导安装

---

## 安装与首次运行

### 1. 编译（如果没有现成 exe）

**环境要求：** Windows 10/11 x64 + Visual Studio 2022

```bat
build.bat
```

### 2. 首次运行

1. 双击运行 `autokey.exe`
2. 程序检测到 Interception 驱动未安装，弹出提示框，点击 **"是"**
3. 以管理员权限自动安装驱动
4. **安装完成后必须重启电脑**，驱动才能加载
5. 重启后再次运行 `autokey.exe`，界面显示 **"✔ Interception 驱动就绪"** 即可使用

---

## 快捷键一览

| 按键 | 功能 | 说明 |
|------|------|------|
| **F3** | 切换模式 | 在 Hold 模式和 Toggle 模式之间切换 |
| **F4** | 设置按键列表 | Hold 模式：设置不连发的键；Toggle 模式：设置连发键 |
| **F5** | 减少延迟 | ≥10ms 时每次 -1ms，<10ms 时每次 -100μs |
| **F6** | 增加延迟 | 与 F5 相反 |
| **F7** | 开启/关闭连发 | 主开关，必须开启后连发功能才生效 |
| **F8** | 退出程序 | 保存配置并退出 |
| **F9** | 游戏模式 | 切换半透明悬浮窗 |

---

## 详细功能说明

### Hold 模式（按住连发）

这是默认模式，适合需要"按住某个键持续连发"的场景。

**使用方法：**
1. 按 **F7** 开启连发功能（状态显示"已开启"）
2. 按住任意键，该键会被自动连发
3. 松开键，连发停止
4. 按 **F7** 关闭连发功能

**排除键设置：**

Hold 模式下有些键不应该被连发（如移动键 WASD），可以通过 F4 设置排除列表。

默认排除的键：`W` `A` `S` `D` `Tab` `Space` `Enter` `Shift`

修改排除列表：
1. 确保连发功能已**关闭**（F7 关闭）
2. 按 **F4**，界面显示 ">> 按下要 添加/移除 的不连发键 <<"
3. 按下你想要排除或取消排除的键
4. 设置完成，自动保存

### Toggle 模式（按一下开始/再按停止）

适合需要"按一下某个键就一直连发，再按一下停止"的场景。

**使用方法：**
1. 按 **F3** 切换到 Toggle 模式
2. 先通过 **F4** 设置哪些键可以被 Toggle（白名单）
3. 按 **F7** 开启连发功能
4. 按下白名单中的某个键，该键开始自动连发
5. 再按一下同一个键，连发停止

**设置连发键白名单：**
1. 确保连发功能已**关闭**
2. 按 **F4**，界面显示 ">> 按下要 添加/移除 的连发键 <<"
3. 按下你想要添加或移除的键
4. 设置完成，自动保存

> **Hold 和 Toggle 的区别：**
> - Hold：按住 = 连发，松开 = 停止。所有键默认可连发（排除列表中的除外）
> - Toggle：按一下 = 开始连发，再按一下 = 停止。只有白名单中的键可连发

### 延迟调节

延迟控制每次按键之间的间隔时间，延迟越小速度越快。

| 延迟范围 | F5/F6 步进 | 显示格式 |
|---------|-----------|---------|
| ≥ 10ms | 每次 1ms | `50ms` |
| 1ms ~ 9.9ms | 每次 100μs | `900μs (0.9ms)` |
| 100μs（最小值） | 进入 burst 模式 | `100μs x5` |

**Burst 模式：**

当延迟减到 100μs 后，继续按 F5 不会再减小延迟，而是增加每个周期内的发送次数：

```
100μs x1 → 100μs x2 → 100μs x3 → ... → 100μs x1000
```

每个 100μs 间隔内发送多次按键，理论上可以达到极高的按键速率。

按 F6 会反向操作：先减少 burst 次数，burst 回到 1 后再增加延迟。

### 游戏模式（F9）

游戏模式将窗口变为半透明无边框悬浮窗，只显示最关键的 3 行信息，不遮挡游戏画面。

**进入游戏模式：** 按 **F9**

- 窗口变为半透明（约 35% 不透明度）
- 隐藏标题栏和所有详细信息
- 仅显示：**状态** / **连发中的按键** / **速度**
- 鼠标按住窗口任意位置可拖拽移动
- 窗口位置和大小会自动记忆，下次 F9 进入时恢复

**退出游戏模式：** 再按 **F9**，恢复正常界面。

> 游戏模式下所有快捷键（F3~F8）仍然正常工作。

### 界面信息说明

正常模式下窗口显示以下信息：

| 行 | 说明 |
|----|------|
| Interception 驱动就绪/未就绪 | 驱动加载状态 |
| 状态 | 连发功能是否开启，以及当前模式 |
| 模式 | Hold（全部连发）或 Toggle（指定连发） |
| 连发中 | 当前正在连发的按键列表 |
| 按键间隔 | 当前延迟设置 |
| 速度 | 实时每秒按键次数（开启连发时显示） |
| 不连发/连发键 | Hold 模式显示排除列表，Toggle 模式显示白名单 |

---

## 配置文件

所有设置自动保存到程序同目录的 `config.json`：

```json
{
  "delay_us": 50000,
  "burst": 1,
  "mode": 0,
  "exclude": [87, 65, 83, 68, 9, 32, 13, 16],
  "custom_keys": [],
  "game_x": 100,
  "game_y": 200,
  "game_w": 200,
  "game_h": 80
}
```

| 字段 | 说明 |
|------|------|
| `delay_us` | 延迟（微秒），50000 = 50ms |
| `burst` | burst 模式倍数，默认 1 |
| `mode` | 0 = Hold，1 = Toggle |
| `exclude` | Hold 模式排除键的 VK 码列表 |
| `custom_keys` | Toggle 模式白名单键的 VK 码列表 |
| `game_x/y/w/h` | 游戏模式窗口位置和大小 |

---

## 项目结构

```
├── main.c                    # 主程序源码（单文件，约 1200 行）
├── build.bat                 # 一键编译脚本
├── interception.h            # Interception 驱动 API 头文件
├── interception.dll          # Interception 运行库（编译时嵌入 exe）
├── install-interception.exe  # 驱动安装程序（编译时嵌入 exe）
├── resource.h                # 资源 ID 定义
└── resource.rc               # 资源脚本（将 dll 和 exe 嵌入）
```

编译后生成单个 `autokey.exe`，内嵌了 `interception.dll` 和 `install-interception.exe`，无需额外文件即可运行和安装驱动。

## 技术实现

- **按键捕获：** Interception 驱动拦截所有键盘事件，记录按下/释放状态
- **按键发送：** `interception_send()` 批量发送按下+释放两个事件（1 次调用）
- **高精度计时：** `QueryPerformanceCounter` 实现微秒级延迟精度，大延迟用 `Sleep` 节省 CPU，最后一段用 QPC 自旋精确等待
- **线程模型：** 捕获线程 + 发送线程分离，发送线程设为 `THREAD_PRIORITY_TIME_CRITICAL`
- **活跃按键追踪：** 最多 16 个活跃槽位，预计算扫描码和 flags，热循环零系统调用开销

## 注意事项

- Interception 驱动安装需要**管理员权限**
- 安装驱动后必须**重启电脑**
- 部分反作弊系统可能检测 Interception 驱动，请自行评估风险
- F3~F9 为程序功能键，在连发中不会被触发连发

## 依赖

- [Interception](https://github.com/oblitum/Interception) — 键盘/鼠标驱动级拦截框架

## License

MIT
