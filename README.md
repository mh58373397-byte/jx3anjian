# 丐帮高手 v4.0 — 驱动级键盘/鼠标连发工具

基于 [Interception](https://github.com/oblitum/Interception) 驱动的高性能连发工具，在驱动层模拟键盘和鼠标输入，支持微秒级精度控制。带可视化键盘布局的图形界面，支持键位对调、宏录制回放、音效提示等丰富功能。

## 功能特性

### 核心连发

- **驱动级按键模拟** — 通过 Interception 驱动在内核层发送键盘/鼠标事件，非应用层模拟
- **三种连发模式** — Hold（按住连发）、Toggle（指定连发）、Hybrid（混合模式）
- **键盘+鼠标支持** — 键盘按键和鼠标五键（左/右/中/X1/X2）均可连发
- **可视化键盘布局** — 界面内嵌键盘图（含鼠标键），点击即可设置排除/连发
- **微秒级延迟控制** — 延迟范围 1μs ~ 1000ms，极速模式可突破 1ms 下限

### 键位对调（v4.0 新增）

- **拖拽对调** — 在模拟键盘上按住鼠标拖动一个键到另一个键，即可交换两个键的功能
- **驱动层生效** — 对调在 Interception 驱动层实现，对所有应用全局有效
- **视觉反馈** — 对调后的键在虚拟键盘上显示对调目标的标签和颜色
- **独立开关** — 可选择"不开启连发键位调也生效"，让对调功能独立于连发工作

### 宏录制与回放（v4.0 新增）

- **最多 5 组宏** — 每组宏可独立录制、命名、设置快捷键
- **精确回放** — 录制键盘和鼠标事件的精确时间间隔，完美还原操作
- **宏启停键** — 为每组宏设置独立的播放和停止快捷键（支持键盘和鼠标按键）
- **独立开关** — 可选择"不开启连发宏也生效"，让宏功能独立于连发工作

### 界面与体验

- **音效提示** — 开启/关闭连发时播放提示音，可通过喇叭按钮一键开关
- **暂停模式** — 停止连发时保留已指定的按键，下次启动自动恢复
- **极速模式** — 允许按键间隔低于 1ms，最低可达 1μs
- **游戏模式** — 半透明无边框悬浮窗，不遮挡游戏画面
- **实时速度显示** — 显示每秒实际按键次数（PPS）
- **可自定义快捷键** — 启动/关闭连发、游戏模式的热键均可自定义
- **配置持久化** — 所有设置（含键位对调、宏内容）自动保存/加载
- **驱动管理** — 支持一键安装和卸载驱动

---

## 安装与首次运行

### 1. 编译（如果没有现成 exe）

**环境要求：** Windows 10/11 x64 + Visual Studio 2022

```bat
build.bat
```

### 2. 首次运行

1. 双击运行 `autokey.exe`
2. 程序检测到 Interception 驱动未安装，弹出提示框，点击 **"是"**
3. 以管理员权限自动安装驱动
4. **安装完成后必须重启电脑**，驱动才能加载
5. 重启后再次运行 `autokey.exe`，界面显示 **"✔ Interception 驱动就绪"** 即可使用

---

## 快捷键一览

| 默认按键 | 功能 | 说明 |
|----------|------|------|
| **F1** | 开启/关闭连发 | 主开关，可在界面中点击「改」自定义 |
| **F9** | 游戏模式 | 切换半透明悬浮窗，可在界面中点击「改」自定义 |

> 快捷键可在界面中点击「启停」或「游戏」旁的「改」按钮重新设置，按 Esc 取消设置。

---

## 详细功能说明

### 三种连发模式

| 模式 | 说明 |
|------|------|
| **Hold（按住连发）** | 按住任意键 = 连发，松开 = 停止。橙色键可连发，红色键为排除 |
| **Toggle（指定连发）** | 按一下白名单中的键 = 开始连发，再按 = 停止。绿色键为已选 |
| **Hybrid（混合模式）** | 绿色键可 Toggle，橙色键可 Hold，红色键为排除。同时支持两种方式 |

### 按键设置方式

通过**点击界面上的键盘图**来设置（需关闭"键位对调"复选框）：

- **Hold 模式**：点击键盘上的键，橙色↔红色切换（连发↔不连发）
- **Toggle 模式**：点击键盘上的键，绿色↔灰色切换（已选↔未选）
- **Hybrid 模式**：点击循环切换：绿色（指定连发）→ 红色（排除）→ 橙色（按住连发）

灰色键为热键（启停/游戏/宏绑定），不可配置。

### 键位对调

勾选 **「键位对调」** 复选框后：

1. 在模拟键盘上**按住鼠标左键**，从一个键**拖动**到另一个键
2. 松开鼠标，两个键完成对调
3. 对调后，按物理键 A 将触发键 B 的功能，反之亦然
4. 再次将已对调的两个键互相拖动，可**取消对调**
5. 对调后的键在虚拟键盘上以**橙黄色**显示，且标签和颜色状态跟随对调目标

勾选 **「不开启连发键位调也生效」** 后，键位对调无需开启连发即可工作。

### 宏录制与回放

点击 **「宏录制」** 按钮打开宏设置窗口：

1. 从下拉框选择宏槽位（最多 5 组），可重命名
2. 点击 **「录制」** 开始录制键盘和鼠标操作
3. 点击 **「停止」** 结束录制，脚本自动保存
4. 勾选 **「生效」** 启用该宏
5. 设置 **「宏启停键」** 为每组宏指定播放/停止的快捷键

在主界面勾选 **「宏生效」** 全局启用宏功能。勾选 **「不开启连发宏也生效」** 后，宏功能无需开启连发即可工作。

### 音效提示

开启/关闭连发时会播放提示音（需要 `按键开启.mp3` 和 `按键关闭.mp3` 在程序同目录）。点击状态栏旁的 **喇叭按钮** 可开关音效。

### 鼠标按键

键盘图右上方显示 5 个鼠标按键（ML/MR/MM/X1/X2），设置方式与键盘相同。

### 暂停模式

勾选 **「暂停模式」** 后，启动/停止的逻辑变为启动/暂停：
- 停止连发时**保留**已指定的按键状态
- 下次启动时自动恢复之前的连发按键

### 极速模式

勾选 **「极速模式」** 后：
- 允许按键间隔低于 1ms（最低可达 1μs）
- **警告**：过低的间隔可能导致电脑卡死，请谨慎使用

### 延迟调节

使用界面上的 **-** 和 **+** 按钮调节按键间隔：

| 延迟范围 | 步进 | 说明 |
|---------|------|------|
| ≥ 10ms | 每次 1ms | 标准模式 |
| 1ms ~ 9.9ms | 每次 100μs | 显示 μs 和 ms 双单位 |
| < 1ms（极速模式） | 10μs / 1μs | 需开启极速模式 |

### 游戏模式

按默认热键 **F9**：

- 窗口变为半透明无边框悬浮窗（约 35% 不透明度），始终置顶
- 仅显示：**状态** / **连发中的按键** / **速度**
- 鼠标拖拽窗口可移动，右键弹出菜单
- 窗口位置和大小自动记忆

再次按热键退出游戏模式。

---

## 配置文件

所有设置自动保存到程序同目录的 `config.json`，包含：

| 字段 | 说明 |
|------|------|
| `delay_us` | 延迟（微秒），1000 = 1ms |
| `mode` | 0 = Hold，1 = Toggle，2 = Hybrid |
| `exclude` | Hold 模式排除键的 VK 码列表 |
| `custom_keys` | Toggle 模式白名单键的 VK 码列表 |
| `game_x/y/w/h` | 游戏模式窗口位置和大小 |
| `hk_toggle` | 启动/关闭连发热键的 VK 码（默认 112 = F1） |
| `hk_game` | 游戏模式热键的 VK 码（默认 120 = F9） |
| `key_lock` | 暂停模式开关 |
| `turbo` | 极速模式开关 |
| `macro_active` | 宏全局启用开关 |
| `swap_enabled` | 键位对调开关 |
| `key_swaps` | 键位对调映射列表，如 `[[49,123]]` 表示 1↔F12 |
| `macros` | 宏槽位数据（名称、脚本、快捷键、启用状态） |

---

## 项目结构

```
├── main.c                    # 主程序源码（约 2200 行）
├── macro.c                   # 宏录制/回放模块
├── macro.h                   # 宏模块头文件
├── build.bat                 # 一键编译脚本
├── interception.h            # Interception 驱动 API 头文件
├── interception.dll          # Interception 运行库（编译时嵌入 exe）
├── install-interception.exe  # 驱动安装程序（编译时嵌入 exe）
├── resource.h                # 资源 ID 定义
├── resource.rc               # 资源脚本（将 dll 和 exe 嵌入）
├── app.manifest              # 应用程序清单
├── 按键开启.mp3              # 连发开启音效
├── 按键关闭.mp3              # 连发关闭音效
└── autokey.exe               # 编译产物
```

编译后生成单个 `autokey.exe`，内嵌了 `interception.dll` 和 `install-interception.exe`，无需额外文件即可运行和安装驱动。音效文件需放在程序同目录。

## 技术实现

- **按键捕获：** Interception 驱动拦截所有键盘和鼠标事件，记录按下/释放状态
- **按键发送：** `interception_send()` 批量发送按下+释放两个事件（1 次调用）
- **键位对调：** 在 Interception 接收到按键后、发送前，替换扫描码和 E0 标志，驱动层全局生效
- **高精度计时：** `QueryPerformanceCounter` 实现微秒级延迟精度，大延迟用 `Sleep` 节省 CPU，最后一段用 QPC 自旋精确等待
- **宏录制：** 通过 Interception 钩子捕获原始扫描码和时间戳，回放时精确还原时间间隔
- **线程模型：** 捕获线程 + 发送线程分离，发送线程设为 `THREAD_PRIORITY_TIME_CRITICAL`
- **线程安全：** 活跃槽位使用临界区保护，PPS 计数使用原子操作，按键状态使用快照读取
- **双缓冲渲染：** 缓存兼容 DC 和 bitmap，仅窗口大小变化时重建，消除界面闪烁
- **DLL 动态加载：** 从资源释放 `interception.dll` 到临时目录后加载，单 exe 分发
- **音效播放：** 使用 `mciSendStringW` 播放 MP3 文件

## 注意事项

- Interception 驱动安装需要**管理员权限**
- 安装驱动后必须**重启电脑**
- 可通过界面「卸载」按钮卸载 Interception 驱动
- 部分反作弊系统可能检测 Interception 驱动，请自行评估风险
- 启停热键和游戏模式热键在连发中不会被触发
- 键位对调不支持鼠标按键和热键/宏绑定键

## 依赖

- [Interception](https://github.com/oblitum/Interception) — 键盘/鼠标驱动级拦截框架

## License

MIT
